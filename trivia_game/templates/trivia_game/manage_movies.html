{% extends 'trivia_game/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    {% csrf_token %}
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">Movie Management</h2>
                    <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addMovieModal">
                        <i class="fas fa-plus"></i> Add Movie
                    </button>
                </div>
                <div class="card-body">
                    <!-- Search Bar -->
                    <div class="mb-4">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="movieSearch" class="form-control" placeholder="Search movies...">
                        </div>
                    </div>

                    <!-- Movie List -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Release Date</th>
                                    <th>Genre</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="movieList">
                                {% for movie in movies %}
                                <tr>
                                    <td>{{ movie.title }}</td>
                                    <td>{{ movie.release_date }}</td>
                                    <td>{{ movie.genre }}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm delete-movie" data-movie-id="{{ movie.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Movie Modal -->
<div class="modal fade" id="addMovieModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Movie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMovieForm">
                    <div class="mb-3">
                        <label for="movieTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="movieTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="releaseDate" class="form-label">Release Date</label>
                        <input type="number" class="form-control" id="releaseDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="genre" class="form-label">Genre</label>
                        <input type="text" class="form-control" id="genre" required>
                    </div>
                    <div class="mb-3">
                        <label for="director" class="form-label">Director</label>
                        <input type="text" class="form-control" id="director">
                    </div>
                    <div class="mb-3">
                        <label for="actors" class="form-label">Actors (comma-separated)</label>
                        <input type="text" class="form-control" id="actors">
                    </div>
                    <div class="mb-3">
                        <label for="studio" class="form-label">Studio</label>
                        <input type="text" class="form-control" id="studio">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitMovie">Add Movie</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let isSubmitting = false;
    
    // Search functionality
    const searchInput = document.getElementById('movieSearch');
    const movieList = document.getElementById('movieList');
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = movieList.getElementsByTagName('tr');
        
        Array.from(rows).forEach(row => {
            const title = row.cells[0].textContent.toLowerCase();
            row.style.display = title.includes(searchTerm) ? '' : 'none';
        });
    });

    // Add movie functionality
    function handleSubmit() {
        if (isSubmitting) return;
        isSubmitting = true;

        const title = document.getElementById('movieTitle').value;
        const releaseDate = document.getElementById('releaseDate').value;
        const genre = document.getElementById('genre').value;
        const director = document.getElementById('director').value;
        const actors = document.getElementById('actors').value;
        const studio = document.getElementById('studio').value;

        // Basic validation
        if (!title || !releaseDate || !genre) {
            alert('Please fill in all required fields');
            isSubmitting = false;
            return;
        }

        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Prepare data
        const data = {
            title: title,
            release_date: releaseDate,
            genre: genre,
            director: director,
            actors: actors.split(',').map(actor => actor.trim()),
            studio: studio
        };

        // Send request
        fetch('/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new row to table
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${title}</td>
                    <td>${releaseDate}</td>
                    <td>${genre}</td>
                    <td>
                        <button class="btn btn-danger btn-sm delete-movie" data-movie-id="${data.movie_id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                movieList.appendChild(newRow);

                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('addMovieModal'));
                modal.hide();
                document.getElementById('addMovieForm').reset();

                // Add delete listener to new button
                const deleteButton = newRow.querySelector('.delete-movie');
                deleteButton.addEventListener('click', (e) => handleDelete(e, deleteButton));
            } else {
                alert('Error adding movie: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding movie');
        })
        .finally(() => {
            isSubmitting = false;
        });
    }

    // Delete movie functionality
    function handleDelete(e, button) {
        e.preventDefault();
        if (!confirm('Are you sure you want to delete this movie?')) return;

        const movieId = button.dataset.movieId;
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`{% url 'trivia_game:delete_movie' '0' %}`.replace('0', movieId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Accept': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const row = button.closest('tr');
                if (row) {
                    row.remove();
                }
            } else {
                alert('Error deleting movie: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting movie: ' + error.message);
        });
    }

    // Add submit listener
    const submitButton = document.getElementById('submitMovie');
    // Remove any existing event listeners
    submitButton.replaceWith(submitButton.cloneNode(true));
    const newSubmitButton = document.getElementById('submitMovie');
    newSubmitButton.addEventListener('click', handleSubmit);

    // Add delete listeners to existing buttons
    document.querySelectorAll('.delete-movie').forEach(button => {
        // Remove any existing listeners by cloning the button
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        // Add the new listener
        newButton.addEventListener('click', (e) => handleDelete(e, newButton));
    });
});
</script>
{% endblock %}